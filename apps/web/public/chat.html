<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>
  <body class="bg-gray-50 h-full">
    <div class="flex flex-col h-full">
      <!-- Header -->
      <div class="bg-blue-600 text-white p-3 font-semibold flex items-center space-x-2">
        <span>ðŸ¤–</span>
        <span>Chat Assistant</span>
      </div>

      <!-- Messages (scrollable) -->
      <div id="chat" class="flex-1 p-3 overflow-y-auto space-y-2 bg-gray-50"></div>

      <!-- Typing indicator -->
      <div id="typing" class="px-3 py-2 text-sm text-gray-500 italic hidden">
        Bot is typing<span class="dot-1">.</span><span class="dot-2">.</span><span class="dot-3">.</span>
      </div>

      <!-- Input (always at bottom) -->
      <div class="p-2 border-t flex items-center space-x-2 bg-white">
        <input
          id="input"
          type="text"
          placeholder="Type a message..."
          class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          autocomplete="off"
        />
        <button
          id="send"
          class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
        >
          Send
        </button>
      </div>
    </div>

    <style>
      /* Animated typing dots */
      #typing span {
        opacity: 0;
        animation: blink 1.5s infinite;
      }
      #typing .dot-1 {
        animation-delay: 0s;
      }
      #typing .dot-2 {
        animation-delay: 0.3s;
      }
      #typing .dot-3 {
        animation-delay: 0.6s;
      }
      @keyframes blink {
        0%,
        80%,
        100% {
          opacity: 0;
        }
        40% {
          opacity: 1;
        }
      }

      .bot-bubble {
        word-break: break-word;
        overflow-wrap: anywhere;
        hyphens: auto;
      }
      .bot-bubble p + p { margin-top: 0.4rem; }
      .bot-bubble ul { list-style: disc; margin: 0.25rem 0 0.25rem 1.25rem; }
      .bot-bubble ol { list-style: decimal; margin: 0.25rem 0 0.25rem 1.25rem; }
    </style>

    <script>
      const chatDiv = document.getElementById("chat");
      const input = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const typingDiv = document.getElementById("typing");

      function addMessage(sender, text) {
        const wrapper = document.createElement("div");
        wrapper.className =
          sender === "You" ? "flex justify-end" : "flex justify-start";

        const bubble = document.createElement("div");
        bubble.className =
          (sender === "You"
            ? "bg-blue-600 text-white"
            : "bg-gray-200 text-gray-800") +
          " px-3 py-2 rounded-lg max-w-[85%]";
        if (sender === "Bot") {
          bubble.classList.add("bot-bubble");
          bubble.innerHTML = renderMarkdown(text);
        } else {
          bubble.textContent = text;
        }

        wrapper.appendChild(bubble);
        chatDiv.appendChild(wrapper);

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            chatDiv.scrollTop = chatDiv.scrollHeight;
          });
        });
      }

      let accessToken = null;

      // Allowed parent origin (injected from server env var)
      const ALLOWED_ORIGIN = '__ENV_ALLOWED_ORIGIN__';

      window.parent.postMessage("chat-ready", "*"); // tell parent we're ready

      window.addEventListener("message", (event) => {
        if (event.origin !== ALLOWED_ORIGIN) {
          console.warn("Rejected message from unauthorized origin:", event.origin);
          return;
        }

        // Handle auth-token message format from parent
        if (event.data?.type === "auth-token") {
          accessToken = event.data.token;
          console.log("Access token received:", accessToken ? "âœ“" : "null");
        }
      });

      let conversationId = null;
      let isLoading = false;

      async function sendMessage() {
        if (isLoading) return;

        if (!accessToken) {
          addMessage("Bot", "âš ï¸ Not authenticated.");
          return;
        }
        
        const message = input.value.trim();
        if (!message) return;

        addMessage("You", message);
        input.value = "";

        // Show typing indicator
        typingDiv.classList.remove("hidden");
        setLoading(true);
        isLoading = true;

        try {
          const res = await fetch("http://localhost:3001/chat", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify({ message, conversationId }),
          });

          const data = await res.json();

          if (data.conversationId && !conversationId) {
            conversationId = data.conversationId;
          }

          // Hide typing indicator
          typingDiv.classList.add("hidden");
          setLoading(false);
          isLoading = false;

          addMessage("Bot", data.reply);
        } catch (err) {
          typingDiv.classList.add("hidden");
          addMessage("Bot", "âš ï¸ Error: Could not get response.");
        }
      }

      function renderMarkdown(md) {
        const html = marked.parse(md, { breaks: true, gfm: true });
        return DOMPurify.sanitize(html);
      }

      function setLoading(isLoading) {
        const btn = document.getElementById("send");
        const input = document.getElementById("input");

        btn.disabled = isLoading;
        input.disabled = isLoading;

        if (isLoading) {
          btn.dataset.prevText = btn.textContent;
          btn.textContent = "Sendingâ€¦";
          btn.classList.add("opacity-60", "cursor-not-allowed");
        } else {
          btn.textContent = btn.dataset.prevText || "Send";
          btn.classList.remove("opacity-60", "cursor-not-allowed");
          input.focus();
        }
      }

      sendBtn.addEventListener("click", sendMessage);
      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !isLoading) sendMessage();
        if (e.key === "Enter" && isLoading) e.preventDefault();
      });
    </script>
  </body>
</html>